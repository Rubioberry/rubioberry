<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rubioberry Gas Futures — Bet on Ethereum Gas Prices (Lone bets refunded)</title>
    <link rel="stylesheet" href="/packages/ui/index.css">
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<video autoplay muted loop playsinline id="bg-video">
    <source src="/BACKGROUND.mp4" type="video/mp4">
</video>

<div class="container">
    <h1>Rubioberry Gas Futures</h1>
    <p>Bet UP or DOWN on Ethereum gas prices — parimutuel markets, settled on TWAP</p>

    <div class="warning" style="margin-bottom:20px; font-size:1.1em; padding:15px;">
        Disclaimer: This is a prediction market involving real ETH. Gamble responsibly. Lone bets (no counter) are refunded.
    </div>

    <div class="success-bar">LIVE ON MAINNET — Berry Edition</div>

    <div class="contract-box">
        <strong>Contract (Audit on Etherscan):</strong><br>
        <a href="https://etherscan.io/address/0x122a6a8378705a77b12b3df72c9a92e27679cc9f" target="_blank" style="color:white;font-weight:bold;text-decoration:none;">
            0x122a6a8378705a77b12b3df72c9a92e27679cc9f
        </a>
    </div>

    <div class="button-group">
        <button id="connectButton" class="btn-main">Connect Wallet (to bet/create)</button>
    </div>
    <div id="walletStatus" class="success-bar">Markets & current gas visible to everyone • Connect wallet to bet or create</div>

    <div class="calc-box" style="margin:40px 0;">
        <h2>Create New Market</h2>
        <input type="number" id="targetGwei" class="calc-input" placeholder="Target gas price (gwei, e.g. 0.000001)" min="0.000001" step="any">
        <input type="number" id="hoursExpiry" class="calc-input" placeholder="Hours until expiry" min="1" value="24">
        <button id="createMarketBtn" class="btn-main">Create Market</button>
        <div class="note">Decimals allowed. Connect wallet to create.</div>
    </div>

    <div class="block-info">
        <h3>Current Gas Price (Base Fee)</h3>
        <div id="currentGas" class="big">Loading...</div>
    </div>

    <div id="marketsGrid" class="berry-grid">
        <div class="note">Loading markets...</div>
    </div>

    <div class="nav-footer">
        <a href="/apps/site/index.html" class="nav-btn">Home</a>
        <a href="/apps/site/RBstakingETHonLido.html" class="nav-btn">Stake ETH</a>
        <a href="/apps/site/contact.html" class="nav-btn">Contact</a>
    </div>
</div>

<script>
    const CONTRACT_ADDRESS = "0x122a6a8378705a77b12b3df72c9a92e27679cc9f";
    const CONTRACT_ABI = [
        "function createMarket(uint256 _targetGwei, uint256 _hoursUntilExpiry) external",
        "function betLong(uint256 marketId) external payable",
        "function betShort(uint256 marketId) external payable",
        "function resolveMarket(uint256 marketId) external",
        "function claim(uint256 marketId) external",
        "function markets(uint256) external view returns (uint256 targetGwei, uint256 expiry, uint256 totalLong, uint256 totalShort, bool resolved, bool longWins)",
        "function longBets(uint256, address) external view returns (uint256)",
        "function shortBets(uint256, address) external view returns (uint256)",
        "function getTWAPGwei() external view returns (uint256)"
    ];

    // Your personal Alchemy endpoint
    const publicProvider = new ethers.JsonRpcProvider("https://eth-mainnet.g.alchemy.com/v2/882nNitaDJakNKIhil2Ag");
    let publicContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, publicProvider);

    let signer, signedContract, userAddress;

    const connectButton = document.getElementById("connectButton");
    const walletStatus = document.getElementById("walletStatus");
    const marketsGrid = document.getElementById("marketsGrid");
    const createMarketBtn = document.getElementById("createMarketBtn");

    async function connectWallet() {
        if (!window.ethereum) {
            walletStatus.textContent = "MetaMask not detected!";
            walletStatus.className = "warning";
            return;
        }

        try {
            const provider = new ethers.BrowserProvider(window.ethereum);
            await provider.send("eth_requestAccounts", []);

            signer = await provider.getSigner();
            userAddress = await signer.getAddress();
            signedContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

            const shortAddress = `${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
            walletStatus.textContent = `Connected: ${shortAddress}`;
            walletStatus.className = "success-bar";
            connectButton.textContent = "Wallet Connected";
            connectButton.disabled = true;

            loadMarkets(true);
        } catch (error) {
            console.error(error);
            walletStatus.textContent = "Connection rejected";
            walletStatus.className = "warning";
        }
    }

    connectButton.addEventListener("click", connectWallet);

    createMarketBtn.addEventListener("click", async () => {
        if (!signedContract) return alert("Connect wallet to create a market");

        const targetStr = document.getElementById("targetGwei").value.trim();
        const hours = document.getElementById("hoursExpiry").value;

        if (!targetStr || Number(targetStr) <= 0 || !hours || hours <= 0) {
            alert("Enter valid target gwei and hours");
            return;
        }

        try {
            const targetWei = ethers.parseUnits(targetStr, 9);
            const tx = await signedContract.createMarket(targetWei, hours);
            walletStatus.textContent = "Creating market... waiting";
            walletStatus.className = "loading";
            await tx.wait();
            walletStatus.textContent = "Market created!";
            walletStatus.className = "success-bar";
            loadMarkets(true);
        } catch (e) {
            console.error(e);
            alert("Create failed: " + (e.message || "Unknown error"));
        }
    });

    async function updateGasPrice() {
        try {
            const block = await publicProvider.getBlock("latest");
            if (!block?.baseFeePerGas) {
                document.getElementById("currentGas").textContent = "N/A";
                return;
            }
            const baseFeeGwei = Number(block.baseFeePerGas) / 1e9;
            document.getElementById("currentGas").textContent = baseFeeGwei.toFixed(6) + " gwei";
        } catch (e) {
            console.error("Gas price error:", e);
            document.getElementById("currentGas").textContent = "Error loading";
        }
    }

    async function loadMarkets(useSigned = false) {
        const contract = useSigned && signedContract ? signedContract : publicContract;

        try {
            marketsGrid.innerHTML = '<div class="note">Loading markets...</div>';

            const now = Math.floor(Date.now() / 1000);
            let hasActive = false;
            let marketId = 0;

            while (true) {
                try {
                    const market = await contract.markets(marketId);

                    if (market.resolved || Number(market.expiry) <= now) {
                        marketId++;
                        continue;
                    }

                    hasActive = true;

                    const pot = Number(market.totalLong) + Number(market.totalShort);
                    const longOdds = pot > 0 ? Math.round((Number(market.totalLong) * 100) / pot) : 50;

                    let userLong = 0, userShort = 0, userBetOn = false;
                    if (useSigned && userAddress) {
                        userLong = Number(await contract.longBets(marketId, userAddress));
                        userShort = Number(await contract.shortBets(marketId, userAddress));
                        userBetOn = userLong > 0 || userShort > 0;
                    }

                    const targetGwei = Number(market.targetGwei) / 1e9;
                    const expiryDate = new Date(Number(market.expiry) * 1000).toLocaleString();

                    const card = document.createElement("div");
                    card.className = "berry-card";
                    card.id = `market-card-${marketId}`;
                    if (userBetOn) card.style.border = "3px solid #00ffb3";

                    card.innerHTML = `
                        <h3>Market #${marketId} — Target: ${targetGwei.toFixed(6)} gwei</h3>
                        <div class="big">Pot: ${ethers.formatEther(pot)} ETH</div>
                        <div class="big">Odds: LONG ${longOdds}% | SHORT ${100 - longOdds}%</div>
                        <div>Expires: ${expiryDate}</div>
                        ${userBetOn ? `<div class="success-bar">YOU BET ON THIS MARKET!</div>` : ""}
                        <div class="button-group">
                            <button class="btn-main" onclick="bet(${marketId}, true)">Bet LONG</button>
                            <button class="btn-sepolia" onclick="bet(${marketId}, false)">Bet SHORT</button>
                        </div>
                        <div class="note">Your bets: LONG ${ethers.formatEther(userLong)} ETH | SHORT ${ethers.formatEther(userShort)} ETH</div>
                    `;

                    marketsGrid.appendChild(card);
                    marketId++;
                } catch (e) {
                    // Assuming the error is due to index out of bounds; break the loop
                    if (e.code === 'CALL_EXCEPTION' || e.code === 'BAD_DATA' || e.message.includes('revert')) {
                        break;
                    } else {
                        throw e;
                    }
                }
            }

            if (!hasActive) {
                marketsGrid.innerHTML = "<div class='note'>No active markets right now — create one!</div>";
            } else if (marketsGrid.innerHTML === '<div class="note">Loading markets...</div>') {
                marketsGrid.innerHTML = "<div class='note'>No active markets right now — create one!</div>";
            }
        } catch (e) {
            console.error(e);
            marketsGrid.innerHTML = `<div class="warning">Error: ${e.message}</div>`;
        }
    }

    async function bet(marketId, isLong) {
        if (!signedContract) return alert("Connect wallet to bet");

        let amountStr = prompt(`How much ETH to bet on ${isLong ? "LONG" : "SHORT"}? (e.g. 0.01)`, "0.01");
        if (!amountStr || parseFloat(amountStr) <= 0) return;

        let value;
        try {
            value = ethers.parseUnits(amountStr.trim(), 18);
        } catch (e) {
            alert("Invalid amount");
            return;
        }

        try {
            const tx = isLong 
                ? await signedContract.betLong(marketId, { value })
                : await signedContract.betShort(marketId, { value });

            walletStatus.textContent = "Tx sent... waiting confirmation";
            walletStatus.className = "loading";
            await tx.wait();
            walletStatus.textContent = "Bet placed successfully!";
            walletStatus.className = "success-bar";
            loadMarkets(true);
        } catch (e) {
            console.error(e);
            alert("Bet failed: " + (e.message || "Unknown error"));
        }
    }

    loadMarkets();
    updateGasPrice();
    setInterval(() => {
        loadMarkets(!!signedContract);
        updateGasPrice();
    }, 60000);

    if (window.ethereum) {
        window.ethereum.request({ method: "eth_accounts" }).then(accounts => {
            if (accounts.length > 0) connectWallet();
        });
    }
</script>
</body>
</html>
