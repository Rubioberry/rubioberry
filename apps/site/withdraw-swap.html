<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rubioberry → Withdraw & Cash Out</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>
    <style>
        :root { --green: #00ffb3; --pink: #ff006e; }
        body {font-family:'Inter',sans-serif;background:#0a0a1f;color:white;margin:0;overflow-x:hidden;}
        #bg-video {position:fixed;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:-1;opacity:0.65;}
        .container {max-width:1300px;margin:0 auto;padding:20px 15px;text-align:center;}
        .success-bar {background:var(--green);color:#000;padding:16px;border-radius:12px;font-weight:bold;margin:15px 0;font-size:1.1em;}
        h1 {font-size:3em;color:var(--green);margin:60px 0 20px;}
        p {font-size:1.4em;opacity:0.9;margin-bottom:50px;}

        .btn-main {
            background:linear-gradient(135deg,#00ffb3,#00d4a0);color:#000;font-weight:bold;
            padding:18px 40px;font-size:1.5em;border-radius:50px;border:none;cursor:pointer;
            box-shadow:0 10px 30px rgba(0,255,179,0.4);transition:all .2s;
            width:100%;max-width:360px;margin:20px auto 0 auto;display:block;
        }
        .btn-main:hover:not(:disabled) {transform:scale(1.05);}
        .btn-main.connected {background:#4CAF50;}
        .btn-withdraw {background:var(--pink);color:white;}
        .btn-smart {background:linear-gradient(135deg,#9b59b6,#8e44ad);color:white;}
        .btn-stable {background:linear-gradient(135deg,#f39c12,#e67e22);color:white;}
        .btn-fiat {background:linear-gradient(135deg,#e74c3c,#c0392b);color:white;}

        /* PERFECT GRID — NO OVERLAP, EQUAL HEIGHT, CENTERED */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
            gap: 50px;
            margin: 80px auto;
            max-width: 1400px;
            justify-content: center;
            align-items: stretch;
        }
        .option-card {
            background:rgba(255,255,255,0.06);
            border:2px solid rgba(0,255,179,0.3);
            border-radius:20px;
            padding:45px 35px;
            text-align:center;
            display:flex;
            flex-direction:column;
            justify-content:space-between;
            min-height:340px;           /* Forces equal height */
            transition:transform 0.3s ease, box-shadow 0.3s ease;
        }
        .option-card:hover {
            transform:translateY(-8px);
            box-shadow:0 25px 50px rgba(0,255,179,0.3);
        }
        .option-card h3 {
            margin:0 0 18px 0;
            color:var(--green);
            font-size:1.65em;
            line-height:1.2;
        }
        .option-card p {
            flex:1;
            font-size:1em;
            opacity:0.9;
            line-height:1.65;
            margin:0 0 20px 0;
            padding:0 10px;
        }

        .status {padding:15px;margin:30px auto;font-weight:bold;border-radius:12px;max-width:600px;}
        .loading {background:rgba(0,255,179,0.2);color:var(--green);}
        .error {background:rgba(255,107,107,0.2);color:#ff6b6b;}

        .note {
            font-size:0.95em;opacity:0.8;margin:70px auto 50px;line-height:1.7;
            background:rgba(255,255,255,0.05);padding:25px;border-radius:14px;max-width:850px;
        }
        .balance-display {
            margin:60px 0;font-size:2.3em;color:var(--green);font-weight:bold;
        }

        #manualSwapBtn {
            display:block !important;
            margin:80px auto !important;
            width:560px !important;
            max-width:92% !important;
        }

        .iframe-container {
            margin:120px auto 80px auto !important;
            max-width:720px;
            border-radius:20px;
            overflow:hidden;
            box-shadow:0 25px 60px rgba(0,255,179,0.3);
            border:3px solid rgba(0,255,179,0.25);
        }
        #cowswap-iframe {width:100%;height:880px;border:none;}

        .contract-box {
            background:rgba(255,255,255,0.07);padding:30px;border-radius:16px;
            border:1px solid rgba(0,255,179,0.3);margin:80px auto;max-width:600px;font-family:monospace;
        }
        .nav-footer {margin:140px 0 60px 0;display:flex;gap:30px;justify-content:center;flex-wrap:wrap;}
        .nav-btn {
            background:linear-gradient(135deg,#00ffb3,#00d4a0);color:#000;padding:20px 50px;
            border-radius:50px;font-size:1.45em;font-weight:bold;text-decoration:none;
            box-shadow:0 12px 35px rgba(0,255,179,0.5);transition:all .2s ease;min-width:220px;
        }
        .nav-btn:hover {transform:scale(1.08) translateY(-5px);box-shadow:0 20px 50px rgba(0,255,179,0.7);}

        @media (max-width: 768px) {
            .options-grid {grid-template-columns:1fr;gap:45px;}
            .option-card {min-height:320px;padding:40px 25px;}
            #manualSwapBtn {width:90%;font-size:1.4em;}
            .iframe-container {margin:100px auto 60px;max-width:100%;}
        }
    </style>
</head>
<body>

<video autoplay muted loop playsinline id="bg-video">
    <source src="BACKGROUND.mp4" type="video/mp4">
</video>

<div class="container">

    <div class="success-bar">MAINNET LIVE — Withdraw Your stETH & Cash Out Seamlessly</div>

    <h1>Withdraw & Cash Out</h1>
    <p>Get your stETH rewards → Swap to ETH/USDC → Or go straight to fiat. Zero hassle, MEV-protected.</p>

    <button id="connectButton" class="btn-main">Connect Wallet</button>
    <div id="status" class="status loading">Click Connect Wallet to begin</div>

    <div id="withdrawSection" style="display:none;">
        <div id="balanceDisplay" class="balance-display">Loading your stETH balance...</div>

        <!-- PERFECT 4-CARD GRID — NO OVERLAP, ALL CENTERED -->
        <div class="options-grid">
            <div class="option-card">
                <h3>Smart Withdraw & Swap to ETH</h3>
                <p>One-click: Withdraw from vault → Auto-swap stETH to ETH (MEV-protected via CoW)</p>
                <button id="smartWithdrawBtn" class="btn-main btn-smart">Withdraw & Swap All → ETH</button>
            </div>
            <div class="option-card">
                <h3>Withdraw to stETH</h3>
                <p>Grab your stETH (with rewards) — liquid & tradable anywhere</p>
                <button id="simpleWithdrawBtn" class="btn-main btn-withdraw">Withdraw All stETH</button>
            </div>
            <div class="option-card">
                <h3>Withdraw & Swap to USDC</h3>
                <p>Convert your rewards to stablecoins instantly</p>
                <button id="stableSwapBtn" class="btn-main btn-stable">Withdraw & Swap → USDC</button>
            </div>
            <div class="option-card">
                <h3>Cash Out to Fiat</h3>
                <p>Withdraw & send directly to bank/card via Ramp (Apple Pay, SEPA, etc.)</p>
                <button id="fiatBtn" class="btn-main btn-fiat">Withdraw & Get Fiat</button>
            </div>
        </div>

        <div class="note">
            <strong>Pro Tip:</strong> CoW Swap gives you the best prices + full MEV protection. Already have stETH? Use the widget below directly.
        </div>

        <button id="manualSwapBtn" class="btn-main" style="display:none;">
            Open Swap Widget (No Withdraw Needed)
        </button>

        <div class="iframe-container" id="swapContainer" style="display:none;">
            <iframe id="cowswap-iframe" src=""></iframe>
        </div>
    </div>

    <div class="contract-box">
        <strong>Your Zero-Fee Vault</strong><br>
        <a href="https://etherscan.io/address/0x7B4fD79c50F54F0367F9243400fB5C75597907e3" target="_blank" style="color:var(--green);font-size:1.1em;">
            0x7B4fD79c50F54F0367F9243400fB5C75597907e3
        </a>
    </div>

    <div class="nav-footer">
        <a href="/apps/site/RBstakingETHonLido.html" class="nav-btn">Back to Staking</a>
        <a href="/apps/site/index.html" class="nav-btn">Home</a>
        <a href="/apps/site/contact.html" class="nav-btn">Contact</a>
        <a href="/apps/gas-futures/gas-futures.html" class="nav-btn">Gas Futures</a>
        <a href="/apps/site/Rubioberry-MEV-Bot.html" class="nav-btn">MEV Bot Dashboard</a>
    </div>

</div>

<script>
    const CONTRACT_ADDRESS = "0x7B4fD79c50F54F0367F9243400fB5C75597907e3";
    const ABI = ["function withdraw(uint256 _shares)","function shares(address) view returns (uint256)","function previewWithdraw(address) view returns (uint256)"];
    const STETH_ADDRESS = "0xae7ab96520DE3A18E5e111B5EaAb095312D7fE84";
    const USDC_ADDRESS = "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48";

    let provider, signer, contract, user;
    let withdrawnAmount = '0';

    const connectBtn = document.getElementById("connectButton");
    const statusEl = document.getElementById("status");
    const withdrawSection = document.getElementById("withdrawSection");
    const balanceDisplay = document.getElementById("balanceDisplay");
    const smartWithdrawBtn = document.getElementById("smartWithdrawBtn");
    const simpleWithdrawBtn = document.getElementById("simpleWithdrawBtn");
    const stableSwapBtn = document.getElementById("stableSwapBtn");
    const fiatBtn = document.getElementById("fiatBtn");
    const manualSwapBtn = document.getElementById("manualSwapBtn");
    const swapContainer = document.getElementById("swapContainer");
    const cowswapIframe = document.getElementById("cowswap-iframe");

    function setStatus(msg, type = "loading") {
        statusEl.textContent = msg;
        statusEl.className = `status ${type}`;
    }

    async function connectWallet() {
        if (!window.ethereum) return setStatus("MetaMask not detected", "error");
        provider = new ethers.BrowserProvider(window.ethereum);
        try {
            await provider.send("eth_requestAccounts", []);
            const net = await provider.getNetwork();
            if (net.chainId !== 1n) await window.ethereum.request({method: "wallet_switchEthereumChain", params: [{chainId: "0x1"}]});
            signer = await provider.getSigner();
            user = await signer.getAddress();
            contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
            connectBtn.textContent = "Wallet Connected"; connectBtn.disabled = true; connectBtn.classList.add("connected");
            withdrawSection.style.display = "block";
            updateBalance();
        } catch (err) { setStatus("Connection failed", "error"); }
    }

    async function updateBalance() {
        if (!contract || !user) return;
        try {
            const amt = await contract.previewWithdraw(user);
            const steth = parseFloat(ethers.formatEther(amt));
            if (steth < 0.0001) {
                balanceDisplay.textContent = "No stETH staked yet"; balanceDisplay.style.color = "white";
                document.querySelectorAll(".option-card button, #manualSwapBtn").forEach(b => b.style.display = "none");
            } else {
                const clean = steth.toFixed(6).replace(/\.?0+$/, "");
                balanceDisplay.innerHTML = `Your balance: ${clean} stETH (with rewards)`;
                balanceDisplay.style.color = "var(--green)";
                document.querySelectorAll(".option-card button, #manualSwapBtn").forEach(b => b.style.display = "block");
                withdrawnAmount = ethers.formatEther(amt);
            }
        } catch (err) {
            balanceDisplay.textContent = "Failed to load balance"; balanceDisplay.style.color = "#ff6b6b";
        }
    }

    async function performWithdraw(toSwap = false, target = 'ETH') {
        try {
            const shares = await contract.shares(user);
            if (shares === 0n) return setStatus("Nothing to withdraw", "error");
            setStatus("Confirm withdrawal in MetaMask...", "loading");
            const tx = await contract.withdraw(shares);
            await tx.wait();
            alert(`Withdrawn successfully!\nhttps://etherscan.io/tx/${tx.hash}`);
            if (toSwap) loadCowSwap(target);
            updateBalance();
        } catch (e) {
            setStatus(e.code === 4001 ? "Cancelled" : "Withdraw failed", "error");
        }
    }

    function loadCowSwap(token = 'ETH') {
        const amount = withdrawnAmount || '1';
        const out = token === 'ETH' ? 'ETH' : USDC_ADDRESS;
        cowswapIframe.src = `https://swap.cow.fi/#/1/swap/${STETH_ADDRESS}/${out}?sellAmount=${amount}&theme=dark&slippage=100`;
        swapContainer.style.display = "block";
        swapContainer.scrollIntoView({behavior: 'smooth'});
    }

    smartWithdrawBtn.onclick = () => performWithdraw(true, 'ETH');
    simpleWithdrawBtn.onclick = () => performWithdraw(false);
    stableSwapBtn.onclick = () => { loadCowSwap('USDC'); performWithdraw(true); };
    fiatBtn.onclick = async () => {
        await performWithdraw(false);
        window.open(`https://ramp.network/sell?swapAsset=ETH&cryptoAmount=${withdrawnAmount}&userAddress=${user}&hostAppName=Rubioberry`, '_blank');
    };
    manualSwapBtn.onclick = () => loadCowSwap('ETH');

    connectBtn.onclick = connectWallet;
    setInterval(() => { if (contract && user) updateBalance(); }, 10000);
    if (window.ethereum) window.ethereum.request({method: "eth_accounts"}).then(a => a.length && connectWallet());
</script>
</body>
</html>